<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.serverboard">

  <!-- ===== 게시글 매핑 ===== -->
  <resultMap id="ServerPostMap" type="com.myspring.vampir.serverboard.vo.ServerPostVO">
    <id     property="id"        column="id"/>
    <result property="world"     column="world"/>
    <result property="server"    column="server_no"/>
    <result property="title"     column="title"/>
    <result property="content"   column="content"/>
    <result property="writer"    column="writer"/>
    <result property="views"     column="views"/>
    <result property="regDate"   column="reg_date"/>
    <result property="imagePath" column="image_path"/>
  </resultMap>

  <!-- 목록 -->
  <select id="listPosts" parameterType="map" resultMap="ServerPostMap">
    SELECT id, world, server_no, title, content, writer, views, reg_date, image_path
    FROM server_posts
    WHERE 1=1
      <if test="world != null and world != '' and world != 'ALL'">
        AND world = #{world}
      </if>
      <if test="server != null and server != '' and server != 'ALL'">
        AND server_no = #{server}
      </if>
    ORDER BY id DESC
  </select>

  <!-- 단건 조회 -->
  <select id="getPost" parameterType="int" resultMap="ServerPostMap">
    SELECT id, world, server_no, title, content, writer, views, reg_date, image_path
    FROM server_posts
    WHERE id = #{id}
  </select>

  <!-- 등록 -->
  <insert id="insertPost"
          parameterType="com.myspring.vampir.serverboard.vo.ServerPostVO"
          useGeneratedKeys="true" keyProperty="id">
    INSERT INTO server_posts (world, server_no, title, content, writer, image_path)
    VALUES (#{world}, #{server}, #{title}, #{content}, #{writer}, #{imagePath})
  </insert>

  <!-- 조회수 +1 -->
  <update id="increaseViews" parameterType="int">
    UPDATE server_posts
    SET views = views + 1
    WHERE id = #{id}
  </update>

  <!-- 수정 (이미지 교체 선택적) -->
  <update id="updatePost" parameterType="com.myspring.vampir.serverboard.vo.ServerPostVO">
    UPDATE server_posts
    <set>
      title   = #{title},
      content = #{content}
      <if test="imagePath != null and imagePath != ''">
        , image_path = #{imagePath}
      </if>
    </set>
    WHERE id = #{id}
      AND writer = #{writer}
  </update>

  <!-- 삭제 (작성자 검증) -->
  <delete id="deletePost" parameterType="map">
    DELETE FROM server_posts
    WHERE id = #{id}
      AND writer = #{writer}
  </delete>

  <!-- ===== 댓글/대댓글 (server_post_comments) ===== -->
  <resultMap id="CommentMap" type="com.myspring.vampir.serverboard.vo.ServerCommentVO">
    <id     property="id"       column="id"/>
    <result property="postId"   column="post_id"/>
    <result property="parentId" column="parent_id"/>
    <result property="writer"   column="writer"/>
    <result property="content"  column="content"/>
    <result property="regDate"  column="reg_date"/>
  </resultMap>

  <!-- 댓글 목록: 부모먼저, 자식순 -->
  <select id="listComments" parameterType="int" resultMap="CommentMap">
    SELECT id, post_id, parent_id, writer, content, reg_date
    FROM server_post_comments
    WHERE post_id = #{postId}
    ORDER BY
      CASE WHEN parent_id IS NULL THEN id ELSE parent_id END ASC,
      id ASC
  </select>

  <!-- 댓글 등록 -->
  <insert id="insertComment"
          parameterType="com.myspring.vampir.serverboard.vo.ServerCommentVO"
          useGeneratedKeys="true" keyProperty="id">
    INSERT INTO server_post_comments (post_id, parent_id, writer, content)
    VALUES (#{postId}, #{parentId}, #{writer}, #{content})
  </insert>

  <!-- 댓글 수정(작성자 본인) -->
  <update id="updateComment"
          parameterType="com.myspring.vampir.serverboard.vo.ServerCommentVO">
    UPDATE server_post_comments
    SET content = #{content}
    WHERE id = #{id}
      AND writer = #{writer}
  </update>

  <!-- 댓글 삭제(작성자 본인) -->
  <delete id="deleteComment" parameterType="map">
    DELETE FROM server_post_comments
    WHERE id = #{id}
      AND writer = #{writer}
  </delete>

</mapper>
